@using X.PagedList
@using X.PagedList.Mvc.Core
@model IPagedList<PruebaTec.WEB.APIClient.DTO.Responses.DetalleVentaResponseDTO>

@{
    ViewData["Title"] = "Detalle de Venta";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var idVenta = ViewBag.IdVenta;
}

<div class="container mt-4">
    <h2 class="mb-4">Registro de productos para la venta (ID: @idVenta)</h2>

    <!-- FORMULARIO -->
    <form asp-action="Create" asp-controller="DetalleVenta" method="post" class="row g-3 mb-4">
        <input type="hidden" name="IdVenta" value="@idVenta" />

        <div class="col-md-2">
            <label class="form-label">Código</label>
            <input type="number" name="IdProducto" id="IdProducto" class="form-control" required />
        </div>

        <div class="col-md-3">
            <label class="form-label">Producto</label>
            <input type="text" id="NombreProducto" class="form-control" readonly />
        </div>

        <div class="col-md-2">
            <label class="form-label">Precio</label>
            <input type="number" step="0.01" name="Precio" id="Precio" class="form-control" required />
        </div>

        <div class="col-md-2">
            <label class="form-label">Cantidad</label>
            <input type="number" name="Cantidad" class="form-control" required />
        </div>

        <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-success w-100">+ Agregar producto</button>
        </div>
    </form>

    <!-- TABLA -->
    <h4 class="mb-3">Detalle de ventas</h4>

    <table class="table table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>IdProducto</th>
                <th>Fecha</th>
                <th>Producto</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>IVA</th>
                <th>Total</th>
                <th>Quitar</th>
            </tr>
        </thead>

        <tbody>
            @if (Model.Any())
            {
                int index = 1;
                decimal subtotal = 0;
                decimal totalIva = 0;
                decimal totalFinal = 0;

                foreach (var detalle in Model)
                {
                    subtotal += detalle.Precio * detalle.Cantidad;
                    totalIva += detalle.Iva;
                    totalFinal += detalle.Total;

                    <tr>
                        <td>@index</td>
                        <td>@detalle.IdProducto</td>
                        <td>@detalle.Fecha.ToString("dd/MM/yyyy")</td>
                        <td>@detalle.NombreProducto</td>
                        <td>$@detalle.Precio.ToString("F2")</td>
                        <td>@detalle.Cantidad</td>
                        <td>$@detalle.Iva.ToString("F2")</td>
                        <td>$@detalle.Total.ToString("F2")</td>

                        <td>
                            <form asp-action="Eliminar" asp-controller="DetalleVenta" method="post">
                                <input type="hidden" name="id" value="@detalle.Id" />
                                <input type="hidden" name="idVenta" value="@detalle.IdVenta" />
                                <button type="submit" class="btn btn-sm btn-danger">🗑️</button>
                            </form>
                        </td>
                    </tr>

                    index++;
                }
            }
            else
            {
                <tr>
                    <td colspan="9" class="text-center">No hay detalles registrados para esta venta.</td>
                </tr>
            }
        </tbody>
    </table>

    @if (Model.Any())
    {
        <!-- RESUMEN -->
        <div class="text-end mt-3">
            <p><strong>Sub total:</strong> $@Model.Sum(x => x.Precio * x.Cantidad).ToString("F2")</p>
            <p><strong>Total IVA:</strong> $@Model.Sum(x => x.Iva).ToString("F2")</p>
            <p><strong>Total a pagar:</strong> $@Model.Sum(x => x.Total).ToString("F2")</p>
        </div>
    }

    <!-- PAGINADOR -->
    <div class="d-flex justify-content-center mt-4">
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page, idVenta = idVenta }),
                 new PagedListRenderOptions
        {
            DisplayLinkToFirstPage = PagedListDisplayMode.Always,
            DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
            DisplayLinkToNextPage = PagedListDisplayMode.Always,
            DisplayLinkToLastPage = PagedListDisplayMode.Always,
            DisplayLinkToIndividualPages = true,
            UlElementClasses = new[] { "pagination" },
            LiElementClasses = new[] { "page-item" },
            PageClasses = new[] { "page-link" }
        }
                 )
    </div>

    <div class="mt-4 d-flex justify-content-between">
        <a asp-controller="Venta" asp-action="Index" class="btn btn-secondary">← Volver al listado</a>

        <form id="formConfirmarVenta" asp-action="Confirmar" asp-controller="Venta" method="post">
            <input type="hidden" name="idVenta" value="@idVenta" />
            <button type="button" id="btnConfirmarVenta" class="btn btn-danger">Registrar venta</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- BÚSQUEDA DE PRODUCTO -->
    <script>
        document.getElementById("IdProducto").addEventListener("change", async function () {
            const id = this.value;
            if (!id) return;

            try {
                const response = await fetch(`/Producto/BuscarPorId?id=${id}`);
                if (!response.ok) throw new Error();

                const producto = await response.json();

                document.getElementById("NombreProducto").value = producto.nombre;
                document.getElementById("Precio").value = producto.precio.toFixed(2);

            } catch (error) {
                Swal.fire({
                    icon: "error",
                    title: "Error",
                    text: "No se pudo cargar el producto",
                });

                document.getElementById("NombreProducto").value = "";
                document.getElementById("Precio").value = "";
            }
        });
    </script>

    <!-- CONFIRMAR VENTA -->
    <script>
        document.getElementById("btnConfirmarVenta").addEventListener("click", function () {
            Swal.fire({
                title: "¿Deseas confirmar esta venta?",
                text: "Una vez confirmada no podrás modificarla.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Sí, confirmar",
                cancelButtonText: "Cancelar",
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById("formConfirmarVenta").submit();
                }
            });
        });
    </script>

    <!-- ALERTAS -->
    @if (TempData["Success"] != null)
    {
        <script>
            Swal.fire({ icon: "success", title: "@TempData["Success"]", timer: 2000, showConfirmButton: false });
        </script>
    }
    @if (TempData["Error"] != null)
    {
        <script>
            Swal.fire({ icon: "error", title: "Error", text: "@TempData["Error"]" });
        </script>
    }
    @if (TempData["AlertaTipo"] != null)
    {
        <script>
            Swal.fire({
                icon: "@TempData["AlertaTipo"]",
                title: "@TempData["AlertaMensaje"]",
                timer: 2000,
                showConfirmButton: false
            });
        </script>
    }
}
